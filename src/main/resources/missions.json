{"Clear DSE":{"missionName":"Clear DSE","sequences":[{"name":"Clear dirs","expectedResponse":null,"commands":["sudo service dse stop","sudo rm -rf /var/lib/cassandra/commitlog/*","sudo rm -rf /var/lib/cassandra/saved_caches/*","sudo rm -rf /var/lib/cassandra/hints/*","sudo rm -rf /var/lib/cassandra/data/*"],"concurrencyType":null}]},"Upgrade to DSE 6.8 (QA Repo)":{"missionName":"Upgrade to DSE 6.8 (QA Repo)","sequences":[{"name":"Validate Version","expectedResponse":"6.0.7","commands":["dse -v"],"concurrencyType":null},{"name":"Validate OS","expectedResponse":"1","commands":["lsb_release -a | grep \"Ubuntu 16\" | wc -l"],"concurrencyType":null},{"name":"Add QA Repo","expectedResponse":null,"commands":["sudo rm -rf /etc/apt/sources.list.d/datastax.sources.list","echo \"deb https://qa-automaton:L3wSd31QObv0tgbKruieA@debian-qa.datastax.com/enterprise/ stable main\" | sudo tee -a /etc/apt/sources.list.d/datastax.sources.list"],"concurrencyType":null},{"name":"Stop DSE","expectedResponse":"","commands":["sudo service dse stop","if [ ! \"$(command -v docker)\" ]; then curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh; fi"],"concurrencyType":null},{"name":"Swap Binaries","expectedResponse":null,"commands":["sudo apt-get update","sudo apt-get  -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" -y install aptitude","cp /etc/dse/cassandra/cassandra.yaml .","sudo cp /etc/dse/cassandra/cassandra.yaml /etc/dse/cassandra/cassandra.yaml.old","sudo rm -rf /var/cache/apt/archives/* && sudo apt-get -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" -y install dse-full=6.8.0-1 dse=6.8.0-1 dse-libgraph=6.8.0-1 dse-libsolr=6.8.0-1 dse-libtomcat=6.8.0-1 dse-liblog4j=6.8.0-1 dse-libspark=6.8.0-1 dse-libcassandra=6.8.0-1 dse-libhadoop2-client-native=6.8.0-1 dse-libhadoop2-client=6.8.0-1","sudo cp /etc/dse/cassandra/cassandra.yaml ./cassandra.yaml.maint","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq  merge cassandra.yaml cassandra.yaml.maint > new.cassandra.yaml","sudo cp new.cassandra.yaml /etc/dse/cassandra/cassandra.yaml","sudo cp /usr/share/dse/cassandra/lib/jamm-0.3.3.jar /usr/share/dse/cassandra/lib/jamm-0.3.0.jar","sudo cp /etc/dse/dse.yaml . && sudo cp /etc/dse/dse.yaml /etc/dse/dse.yaml.old","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d dse.yaml 'alwayson_sql_options.jps_directory' > dse.yaml.new","sudo cp dse.yaml.new /etc/dse/dse.yaml"],"concurrencyType":null},{"name":"Start DSE","expectedResponse":"","commands":["sudo service dse start"],"concurrencyType":null}]},"Remove DSE 6.8.0":{"missionName":"Remove DSE 6.8.0","sequences":[{"name":"Stop DSE","expectedResponse":null,"commands":["sudo service dse stop"],"concurrencyType":null},{"name":"Remove package","expectedResponse":null,"commands":["sudo apt-get -y remove \\\n  dse=6.8.0-1 \\\n  dse-full=6.8.0-1 \\\n  dse-libcassandra=6.8.0-1 \\\n  dse-libgraph=6.8.0-1 \\\n  dse-libhadoop2-client-native=6.8.0-1 \\\n  dse-libhadoop2-client=6.8.0-1 \\\n  dse-liblog4j=6.8.0-1 \\\n  dse-libsolr=6.8.0-1 \\\n  dse-libspark=6.8.0-1 \\\n  dse-libtomcat=6.8.0-1"],"concurrencyType":null},{"name":"Clear space (apt archive)","expectedResponse":null,"commands":["sudo rm -rf /var/cache/apt/archives/*"],"concurrencyType":null}]},"NoOp Test Mission":{"missionName":"NoOp Test Mission","sequences":[{"name":"Node","expectedResponse":null,"commands":[" sleep $[ ( $RANDOM % 5 )  + 1 ]s && echo 1","echo 2","sleep 3 && echo 3"],"concurrencyType":"NODE"},{"name":"Cluster","expectedResponse":null,"commands":["sleep 1 && echo 4"," sleep $[ ( $RANDOM % 10 )  + 1 ]s && echo 5","echo 6"],"concurrencyType":"CLUSTER"},{"name":"Node 2","expectedResponse":null,"commands":["sleep 3 && echo 7","echo 8","sleep 1 && echo 9"],"concurrencyType":"NODE"}]},"Restart DSE":{"missionName":"Restart DSE","sequences":[{"name":"restart","expectedResponse":null,"commands":["sudo service dse stop && sudo service dse start"],"concurrencyType":null}]},"restore yamls":{"missionName":"restore yamls","sequences":[{"name":"restore yamls","expectedResponse":null,"commands":["rm -rf cassandra.yaml cassandra.yaml.maint","sudo cp /etc/dse/cassandra/cassandra.yaml.old /etc/dse/cassandra/cassandra.yaml"],"concurrencyType":null}]},"Enable Backups on 6.8+":{"missionName":"Enable Backups on 6.8+","sequences":[{"name":"Config","expectedResponse":null,"commands":["grep -q '^-Ddse.backup_service.enabled=true' /etc/dse/cassandra/jvm.options && sudo sed -i 's/^-Ddse.backup_service.enabled=true/-Ddse.backup_service.enabled=true/' /etc/dse/cassandra/jvm.options || sudo sed -i '1i-Ddse.backup_service.enabled=true'  /etc/dse/cassandra/jvm.options "],"concurrencyType":null},{"name":"restart dse","expectedResponse":null,"commands":["sudo service dse stop && sudo service dse start"],"concurrencyType":null}]},"pull jar and restart":{"missionName":"pull jar and restart","sequences":[{"name":"pull","expectedResponse":null,"commands":["scp ubuntu@{{host}}:{{jar}} .","sudo mv ./dse-db-all-6.8.0-SNAPSHOT.jar /usr/share/dse/cassandra/lib/dse-db-all-6.8.0.jar"],"concurrencyType":"CLUSTER"},{"name":"restart","expectedResponse":null,"commands":["sudo service dse stop && sudo service dse start"],"concurrencyType":"NODE"}]}}