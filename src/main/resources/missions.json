{"Clear DSE":{"missionName":"Clear DSE","sequences":[{"name":"Clear dirs","expectedResponse":null,"commands":["sudo service dse stop","sudo rm -rf /var/lib/cassandra/commitlog/*","sudo rm -rf /var/lib/cassandra/saved_caches/*","sudo rm -rf /var/lib/cassandra/hints/*","sudo rm -rf /var/lib/cassandra/data/*"],"concurrencyType":null}]},"Upgrade to DSE 6.8 (QA Repo)":{"missionName":"Upgrade to DSE 6.8 (QA Repo)","sequences":[{"name":"Validate Version","expectedResponse":"6.0.7","commands":["dse -v"],"concurrencyType":"CLUSTER"},{"name":"Validate OS","expectedResponse":"1","commands":["lsb_release -a | grep \"Ubuntu 16\" | wc -l"],"concurrencyType":"CLUSTER"},{"name":"Add QA Repo","expectedResponse":null,"commands":["sudo rm -rf /etc/apt/sources.list.d/datastax.sources.list","echo \"deb https://{{qa-creds}}@debian-qa.datastax.com/enterprise/ stable main\" | sudo tee -a /etc/apt/sources.list.d/datastax.sources.list"],"concurrencyType":"CLUSTER"},{"name":"Stop DSE","expectedResponse":"","commands":["sudo service dse stop","if [ ! \"$(command -v docker)\" ]; then curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh; fi"],"concurrencyType":"CLUSTER"},{"name":"Swap Binaries","expectedResponse":null,"commands":["sudo apt-get update","sudo apt-get  -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" -y install aptitude","cp /etc/dse/cassandra/cassandra.yaml .","sudo cp /etc/dse/cassandra/cassandra.yaml /etc/dse/cassandra/cassandra.yaml.old","sudo rm -rf /var/cache/apt/archives/* && sudo apt-get -o Dpkg::Options::=\"--force-confdef\" -o Dpkg::Options::=\"--force-confold\" -y install dse-full=6.8.0-1 dse=6.8.0-1 dse-libgraph=6.8.0-1 dse-libsolr=6.8.0-1 dse-libtomcat=6.8.0-1 dse-liblog4j=6.8.0-1 dse-libspark=6.8.0-1 dse-libcassandra=6.8.0-1 dse-libhadoop2-client-native=6.8.0-1 dse-libhadoop2-client=6.8.0-1","sudo cp /etc/dse/cassandra/cassandra.yaml ./cassandra.yaml.maint","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq  merge cassandra.yaml cassandra.yaml.maint > new.cassandra.yaml","sudo cp new.cassandra.yaml /etc/dse/cassandra/cassandra.yaml","sudo cp /usr/share/dse/cassandra/lib/jamm-0.3.3.jar /usr/share/dse/cassandra/lib/jamm-0.3.0.jar","sudo cp /etc/dse/dse.yaml . && sudo cp /etc/dse/dse.yaml /etc/dse/dse.yaml.old","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d dse.yaml 'alwayson_sql_options.jps_directory' > dse.yaml.new","sudo cp dse.yaml.new /etc/dse/dse.yaml"],"concurrencyType":"CLUSTER"},{"name":"Start DSE","expectedResponse":"","commands":["sudo service dse start"],"concurrencyType":"NODE"}]},"Remove DSE 6.8.0":{"missionName":"Remove DSE 6.8.0","sequences":[{"name":"Stop DSE","expectedResponse":null,"commands":["sudo service dse stop"],"concurrencyType":null},{"name":"Remove package","expectedResponse":null,"commands":["sudo apt-get -y remove \\\n  dse=6.8.0-1 \\\n  dse-full=6.8.0-1 \\\n  dse-libcassandra=6.8.0-1 \\\n  dse-libgraph=6.8.0-1 \\\n  dse-libhadoop2-client-native=6.8.0-1 \\\n  dse-libhadoop2-client=6.8.0-1 \\\n  dse-liblog4j=6.8.0-1 \\\n  dse-libsolr=6.8.0-1 \\\n  dse-libspark=6.8.0-1 \\\n  dse-libtomcat=6.8.0-1"],"concurrencyType":null},{"name":"Clear space (apt archive)","expectedResponse":null,"commands":["sudo rm -rf /var/cache/apt/archives/*"],"concurrencyType":null}]},"NoOp Test Mission":{"missionName":"NoOp Test Mission","sequences":[{"name":"Node","expectedResponse":null,"commands":[" sleep $[ ( $RANDOM % 5 )  + 1 ]s && echo 1","echo 2","sleep 3 && echo 3"],"concurrencyType":"NODE"},{"name":"Cluster","expectedResponse":null,"commands":["sleep 1 && echo 4"," sleep $[ ( $RANDOM % 10 )  + 1 ]s && echo 5","echo 6"],"concurrencyType":"CLUSTER"},{"name":"Node 2","expectedResponse":null,"commands":["sleep 3 && echo 7","echo 8","sleep 1 && echo 9"],"concurrencyType":"NODE"}]},"Restart DSE":{"missionName":"Restart DSE","sequences":[{"name":"restart","expectedResponse":null,"commands":["sudo service dse stop && sudo service dse start"],"concurrencyType":null}]},"restore yamls":{"missionName":"restore yamls","sequences":[{"name":"restore yamls","expectedResponse":null,"commands":["rm -rf cassandra.yaml cassandra.yaml.maint","sudo cp /etc/dse/cassandra/cassandra.yaml.old /etc/dse/cassandra/cassandra.yaml"],"concurrencyType":null}]},"Enable Backups on 6.8+":{"missionName":"Enable Backups on 6.8+","sequences":[{"name":"Config","expectedResponse":null,"commands":["grep -q '^-Ddse.backup_service.enabled=true' /etc/dse/cassandra/jvm.options && sudo sed -i 's/^-Ddse.backup_service.enabled=true/-Ddse.backup_service.enabled=true/' /etc/dse/cassandra/jvm.options || sudo sed -i '1i-Ddse.backup_service.enabled=true'  /etc/dse/cassandra/jvm.options "],"concurrencyType":null},{"name":"restart dse","expectedResponse":null,"commands":["sudo service dse stop && sudo service dse start"],"concurrencyType":null}]},"pull jar and restart":{"missionName":"pull jar and restart","sequences":[{"name":"pull","expectedResponse":null,"commands":["scp ubuntu@{{host}}:{{jar}} .","sudo mv ./dse-db-all-6.8.0-SNAPSHOT.jar /usr/share/dse/cassandra/lib/dse-db-all-6.8.0.jar"],"concurrencyType":"CLUSTER"},{"name":"restart","expectedResponse":null,"commands":["sudo service dse stop && sudo service dse start"],"concurrencyType":"NODE"}]},"Install Reaper Sidecar":{"missionName":"Install Reaper Sidecar","sequences":[{"name":"Install with apt-get","expectedResponse":null,"commands":["echo \"deb https://dl.bintray.com/thelastpickle/reaper-deb wheezy main\" | sudo tee -a /etc/apt/sources.list","sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 2895100917357435","sudo apt-get update","sudo apt-get install reaper"],"concurrencyType":"CLUSTER"},{"name":"Configure","expectedResponse":null,"commands":["if [ ! \"$(command -v docker)\" ]; then curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh; fi","sudo cp /etc/cassandra-reaper/cassandra-reaper.yaml /etc/cassandra-reaper/cassandra-reaper.yaml.old && sudo cp /etc/cassandra-reaper/configs/cassandra-reaper-cassandra-sidecar.yaml ./cassandra-reaper.yaml","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq w -i cassandra-reaper.yaml 'useAddressTranslator' true","sudo cp cassandra-reaper.yaml /etc/cassandra-reaper/cassandra-reaper.yaml"],"concurrencyType":"CLUSTER"},{"name":"Restart","expectedResponse":null,"commands":["cqlsh -e \"create KEYSPACE IF NOT EXISTS reaper_db WITH replication = {'class': 'SimpleStrategy', 'replication_factor': 3 };\" && sleep 10","kill -9 $(lsof -i:8080 | grep LISTEN | awk -F\" \" '{print $2}')","sudo service cassandra-reaper start"],"concurrencyType":"NODE"}]},"Cassandra 3.11":{"missionName":"Cassandra 3.11","sequences":[{"name":"Validate Version","expectedResponse":"6.0.7","commands":["dse -v"],"concurrencyType":"CLUSTER"},{"name":"Validate OS","expectedResponse":"1","commands":["lsb_release -a | grep \"Ubuntu 16\" | wc -l"],"concurrencyType":"CLUSTER"},{"name":"Stop DSE","expectedResponse":"","commands":["sudo service dse stop"],"concurrencyType":"CLUSTER"},{"name":"Remove DSE","expectedResponse":null,"commands":["cp /etc/dse/cassandra/cassandra.yaml .","sudo apt-get purge -y dse-full","sudo apt-get purge -y dse"],"concurrencyType":"CLUSTER"},{"name":"Install Cassandra","expectedResponse":null,"commands":["echo \"deb http://www.apache.org/dist/cassandra/debian 311x main\" | sudo tee -a /etc/apt/sources.list.d/cassandra.sources.list","curl -L https://www.apache.org/dist/cassandra/KEYS | sudo apt-key add -","sudo apt-get update && sudo apt-get install -y cassandra","if [ ! \"$(command -v docker)\" ]; then curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh; fi","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml system_keyspaces_filtering","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml nodesync","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml back_pressure_strategy","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml aggregated_request_timeout_in_ms","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml continuous_paging","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml slow_query_log_timeout_in_ms","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml native_transport_keepalive","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml concurrent_materialized_view_builders","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml native_transport_address","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml back_pressure_enabled","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq w -i cassandra.yaml authenticator AllowAllAuthenticator","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq w -i cassandra.yaml authorizer AllowAllAuthorizer","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq w -i cassandra.yaml role_manager CassandraRoleManager","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml cross_dc_rtt_in_ms","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml streaming_connections_per_host","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml seed_gossip_probability","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml pick_level_on_streaming","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml echo_attempts_before_reset","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml concurrent_validations","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml io_global_queue_depth","sudo docker run --rm -i -v ${PWD}:/workdir mikefarah/yq yq d -i cassandra.yaml native_transport_broadcast_address","sudo cp cassandra.yaml /etc/cassandra/cassandra.yaml"],"concurrencyType":"CLUSTER"},{"name":"Clear data","expectedResponse":null,"commands":["sudo rm -rf /mnt/ephemeral/cassandra/data/* && sudo rm -rf /mnt/ephemeral/cassandra/commitlog/* && sudo rm -rf /mnt/ephemeral/cassandra/saved_caches/* && sudo rm -rf /mnt/ephemeral/cassandra/hints/*","sudo rm -rf /var/lib/cassandra/data/* && sudo rm -rf /var/lib/cassandra/commitlog/* && sudo rm -rf /var/lib/cassandra/saved_caches/* && sudo rm -rf /var/lib/cassandra/hints/*\n"],"concurrencyType":"NODE"},{"name":"Start C*","expectedResponse":null,"commands":["sudo service cassandra stop && sudo service cassandra start"],"concurrencyType":"NODE"}]},"Install MCAC":{"missionName":"Install MCAC","sequences":[{"name":"Download and Extract MCAC","expectedResponse":null,"commands":["sudo mkdir /opt/mcac ; sudo chown -R $(whoami) /opt/mcac","curl -s https://api.github.com/repos/datastax/metric-collector-for-apache-cassandra/releases/latest | grep \".*agent.*tar.gz\\\"$\" | cut -d '\"' -f 4 | wget -qi -","tar -xvf datastax*agent*tar.gz -C /opt/mcac"],"concurrencyType":"CLUSTER"},{"name":"Configure","expectedResponse":null,"commands":["grep -q '^MCAC_ROOT=/opt/mcac/datastax-mcac-angent' /etc/cassandra/cassandra-env.sh || echo MCAC_ROOT=$(echo /opt/mcac/datastax-mcac-agent-*/) | sudo tee -a /etc/cassandra/cassandra-env.sh","grep -q '^JVM_OPTS=\"$JVM_OPTS -javaagent:${MCAC_ROOT}/lib/datastax-mcac-agent.jar\"$' /etc/cassandra/cassandra-env.sh || echo 'JVM_OPTS=\"$JVM_OPTS -javaagent:${MCAC_ROOT}/lib/datastax-mcac-agent.jar\"' | sudo tee -a /etc/cassandra/cassandra-env.sh\n"],"concurrencyType":"CLUSTER"},{"name":"Restart C*","expectedResponse":null,"commands":["sudo service cassandra stop && sudo service cassandra start"],"concurrencyType":"NODE"}]}}